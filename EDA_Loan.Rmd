---
title: "Análise Exploratória de Dados de Empréstimo"
author: "Rodrigo Toshiaki Horie"
output: html_notebook
---

# Análise Exploratória de Dados de Empréstimo

## Introdução

Este projeto consiste em realizar uma EDA (Análise Exloratória dos Dados) a partir dos dados fornecidos pela [Prosper](https://www.prosper.com/). Esse conjunto de dados faz parte das [recomendações da Udacity](https://docs.google.com/document/d/1jX3vzkFuFOBGUrlcQ_Lc3jEZVlC_2yyk3tFIbwAI5GQ/edit) para este projeto. 

A Prosper é uma empresa fundada em 2005 com o objetivo de facilitar empréstimos para o mercado dos Estados Unidos. Essa iniciativa já atingiu mais de 15 bilhões de dólares em empréstimos para mais de 920000 pessoas. [Prosper](https://www.prosper.com/about)

O conjunto de dados analisado neste projeto é fornecido por esta empresa e mais sobre o seu conteúdo será abordado futuramente.

Para esta análise serão necessárias as seguintes bibliotecas:

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(gridExtra)

```


## Iniciando a Análise

Primeiro é necessário carregar os dados a partir do csv. Neste projeto chamaremos estes dados de "ld" em referência a loan dataset para facilitar.
Em seguida será exibida a estrutura desse conjunto de dados obtendo a quantidade de variáveis e de observações.

```{r}
ld <- read.csv('prosperLoanData.csv')
str(ld)
```

Como este conjunto de dados contém 81 variáveis, torna-se evidente que existem muitos dados. Então é importante decidir primeiro quais variáveis serão escolhidas para análise e em seguida realizar a limpeza dos dados.

## Escolha e definição das variáveis e limpeza dos dados

Como eu não possuo conhecimento extenso sobre a área serão escolhidas variáveis que ao meu ver podem ser bastante úteis para a análise. Pode ser que variáveis importantes sejam deixadas de lado, mas a ideia aqui será descobrir a relação dessas variáveis em relação aos empréstimos. Dessa forma será possível retornar e alterar a escolha dessas variáveis caso se mostre necessário. 

Será [necessário consultar a definição das variáveis](https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit) para que seja possível fazer a seleção.

- ListingCreationDate: Data da criação da listagem.
- Term: Duração do empréstimo (em meses).
- LoanStatus: Status que pode variar em: Cancelled,  Chargedoff, Completed, Current, Defaulted, FinalPaymentInProgress, PastDue.
- BorrowerRate: Taxa de juros para quem empresta.
- EstimatedReturn: Retorno estimado no momento em que foi criado.
- ProsperScore: Sistema de pontuação usando os dados históricos da Prosper. A pontuação varia de 1-10, sendo 10 a melhor pontuação.
- ListingCategory: categoria do empréstimo divida nas seguintes categorias
    - 0 - Not Available
    - 1 - Debt Consolidation
    - 2 - Home Improvement
    - 3 - Business
    - 4 - Personal Loan
    - 5 - Student Use
    - 6 - Auto
    - 7 - Other
    - 8 - Baby&Adoption
    - 9 - Boat
    - 10 - Cosmetic Procedure
    - 11 - Engagement Ring
    - 12 - Green Loans
    - 13 - Household Expenses
    - 14 - Large Purchases
    - 15 - Medical/Dental
    - 16 - Motorcycle
    - 17 - RV
    - 18 - Taxes
    - 19 - Vacation
    - 20 - Wedding Loans
- Occupation: Profissão do mutuário
- EmploymentStatus: Status do emprego no momento em que a listagem foi criada
- CreditScoreRangeLower: Menor valor de pontuação de crédito de empréstimo
- CreditScoreRangeUpper: Maior valor de pontuação de crédito de empréstimo
- CurrentDelinquencies: Número de contas atrasadas no momento
- AmountDelinquencies: Quantidade em dólares atrasadas
- DebttoIncomeRatio: Taxa de débito por renda 
- StatedMonthlyIncome: Renda mensal declarada
- MonthlyLoanPayment: Pagamento mensal do empréstimo.

Das 81 variáveis foram selecionadas 16 que serão trabalhadas na análise.

```{r}
# Altera o nome da coluna 17 para facilitar seu uso
names(ld)[17]<-paste("ListingCategory")

# Cria novo conjunto de dados apenas com as 18 variáveis escolhidas
ld_clean <- subset(ld, select = c(
    ListingCreationDate,
    Term, 
    LoanStatus,
    BorrowerRate, 
    EstimatedReturn, 
    ProsperScore,
    ListingCategory,
    Occupation, 
    EmploymentStatus,
    CreditScoreRangeLower,
    CreditScoreRangeUpper,
    CurrentDelinquencies,
    AmountDelinquent,
    DebtToIncomeRatio,
    StatedMonthlyIncome, 
    MonthlyLoanPayment
))

# Converte factor para Date
ld_clean$ListingCreationDate <- as.Date(ld_clean$ListingCreationDate)

str(ld_clean)


```

Ao observar a amostra dos dados podemos indicar que há quase 114000 observações, só que muitas delas parecem conter dados incompletos. Por este motivo iremos excluir entradas que possam estar faltando dados e possam compremeter a análise.

```{r}
# Limpa entradas NA
ld_clean <- na.exclude(ld_clean)
str(ld_clean)
```

Essa limpeza foi capaz de reduzir o conjunto de dados para quase metade das observações. 

## Análise Univariada 

### ListingCreationDate

```{r echo=FALSE, message=FALSE, warning=FALSE}

qplot(ListingCreationDate, data = ld_clean, xlab = "Data", ylab = "Empréstimos", main = "Quantidade de empréstimos por data") 
    
```

Pode se observar que a quantidade de empréstimos foi aumentando ao longo do tempo, mas algo impactou esse crescimento no final de 2012 e começo de 2013. 

### Term

```{r Term, echo=FALSE, message=FALSE, warning=FALSE}
summary(ld_clean$Term)
qplot(Term, data = ld_clean, xlab = "Tempo em Meses", ylab = "Quantidade", main = "Quantidade de tempo de empréstimo")
```

Pela análise estatística e do gráfico pode-se observar que a maior parte dos empréstimos possuem duração de 36 meses, seguido por 60 meses e uma pequena parcela de 12 meses.

### LoanStatus

```{r LoanStatus}

summary(ld_clean$LoanStatus)

ggplot(ld_clean, aes(LoanStatus)) +
    geom_bar()+
    coord_flip() + 
    labs(x = "Quantidade", y = "Status de Empréstimo", title = "Quantidade de empréstimos por Status ")
```

Pode-se observar que a maior parte dos empréstimos se enquadram em "Current" e "Completed". Dessa forma, os dados dos outros status ficam reduzidos e difíceis de serem observados. Portanto, a seguir esses dois status serão excluídos para que melhore a observação da proporção dos outros status.

```{r}
ggplot(filter(ld_clean, LoanStatus != "Current" &
                LoanStatus != "Completed"),
                aes(LoanStatus)) +
                geom_bar() +
                scale_y_continuous(breaks = seq(0, 10000, 1000)) +
                coord_flip() +
                labs(x = "Quantidade", y = "Status de Empréstimo", title = "Quantidade de empréstimos por Status")
```
Filtrando as cariáveis "Current" e "Completed" pode-se observar que o Status "Chargedoff" também possui uma grande quantidade de empréstimos.

### BorrowerRate

```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(ld_clean$BorrowerRate)
qplot(BorrowerRate, data = ld_clean, xlab = "Taxa de Juros", ylab = "Quantidade de mutuários", main = "Taxa de Juros por Mutuário")
```

Pode-se observar existem alguns valores mais presentes que se destacam. Porém a distribuição mais popular se encontra entre 10 e 20%.

### EstimatedReturn

```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(ld_clean$EstimatedReturn)
qplot(EstimatedReturn , data = ld_clean, xlab = "Retorno estimado", ylab = "Quantidade de empréstimos", main = "Retorno estimado por quantidade de empréstimos")

```

Esse gráfico consegue reprentar com certa fidelidade uma relação de distribuição normal com relação aos dados de retorno estimado apra cada empréstimo realizado. Com a maior concentração de seus valores em cerca de 0,9%. Curioso destacar que há retornos estimados com valores negativos.

### ProsperScore

```{r echo=FALSE, message=FALSE, warning=FALSE}
qplot(ProsperScore , data = ld_clean, xlab = "Retorno estimado", ylab = "Quantidade de empréstimos", main = "Retorno estimado por quantidade de empréstimos")

```

Essa relação também parece representar uma distribuição normal. Como se trata de uma avaliação própria da empresa será mais intieressante a exploração futura com relação a outras variáveis para determinar seu impacto.

### ListingCategory

Esta categoria é tratada de forma diferente, porém vale lembrar que apesar de estarmos lidando com uma lista enumerada segue a seguir cada um de suas respectivas categorias:
  
0 - Not Available  
1 - Debt Consolidation  
2 - Home Improvement  
3 - Business  
4 - Personal Loan  
5 - Student Use  
6 - Auto  
7 - Other  
8 - Baby and Adoption  
9 - Boat  
10 - Cosmetic Procedure  
11 - Engagement Ring  
12 - Green Loans  
13 - Household Expenses  
14 - Large Purchases  
15 - Medical/Dental  
16 - Motorcycle  
17 - RV  
18 - Taxes  
19 - Vacation  
20 - Wedding Loans  

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(ld_clean, aes(ListingCategory)) +
                geom_bar() +
                scale_x_continuous() +
                labs(x = "Categoria", y = "Quantidade de Empréstimos", title = "Quantidade de empréstimos por Categoria") 

```

Consolidação de Crédito é o principal motivo para que as pessoas busquem empréstimos na Prosper. Dessa forma a relação das outras categorias fica nebulosa. Por isso será criado um novo gráfico ignorando a Consolidação de Crédito para que seja possível comparar a relação com as outras categorias.

```{r}
ggplot(filter(ld_clean, ListingCategory != "1"), aes(ListingCategory)) +
                geom_bar() +
                scale_x_continuous() +
                labs(x = "Categoria", y = "Quantidade de Empréstimos", title = "Quantidade de empréstimos por Categoria") 
```

Agora já é possível observar que o segundo motivo para o empréstimo na Prosper é encaixado na categoria "Outros" o que é razoável já que essa é uma categoria genérica que engloba diversas outras categorias não catalogadas. Em seguida é "Melhoria Domiciliar", "Negócios" e "Automóveis".

### Occupation

```{r , fig.width=14, fig.height=12 }

ggplot(ld_clean, aes(x = reorder(Occupation, Occupation,  function(x)+length(x)))) +
  geom_bar() +
  coord_flip() +
  theme_minimal() +
  labs(x = "Quantidade", y = "Profissão", title = "Quantidade de Profissões") 

```

Dentre os resultados obtidos será feita uma filtragem com as profissões com "Others" , "Professional" e "" por serem ambíguas.

```{r , fig.width=14, fig.height=12 }

ggplot(filter(ld_clean, Occupation != "Other" & Occupation != "Professional" & Occupation != ""), aes(x = reorder(Occupation, Occupation,  function(x)+length(x)))) +
  geom_bar() +
  coord_flip() +
  theme_minimal() +
  labs(x = "Quantidade", y = "Profissão", title = "Quantidade de Profissões") 

``` 

### EmploymentStatus

```{r}
summary(ld_clean$EmploymentStatus)

ggplot(ld_clean, aes(EmploymentStatus)) +
  geom_bar() +
  theme_minimal() +
  labs(x = "Status de Profissão", y = "Quantidade", title = "Quantidade de Status de Profissões") 

```

Pode-se verificar que a maior parte dos empréstimos foram feitos com pessoas que estavam atualmente empregadas no memomento do empréstimo. 

### CreditScoreRangeLower e CreditScoreRangeUpper

```{r}
summary(ld_clean$CreditScoreRangeLower)

ggplot(ld_clean, aes(CreditScoreRangeLower)) +
  geom_bar() +
  theme_minimal() +
  labs(x = "Variação de Pontuação de Crédito mais Baixa", y = "Quantidade", title = "Quantidade de Pessoas por Variação de Pontuação de Crédito mais Baixa") 

```



```{r}
summary(ld_clean$CreditScoreRangeUpper)

ggplot(ld_clean, aes(CreditScoreRangeUpper)) +
  geom_bar() +
  theme_minimal() +
  labs(x = "Variação de Pontuação de Crédito mais Alta", y = "Quantidade", title = "Quantidade de Pessoas por Variação de Pontuação de Crédito mais Alta") 
```

Observando os gráficos pode-se observar que a distribuição é muito semelhante porém com um breve deslocamento a direita em relação a Variação mais alta. O que faz sentido por que os dois gráficos tratam de uma mesma variável porém com extremos diferentes. Pode-se evidenciar também que a maior concentração de pontuação mais baixa fica em torno do valor de 700 e o mais alto em torno de 719.

### CurrentDelinquencies

```{r}

```


### AmountDelinquencies

```{r}


```
























